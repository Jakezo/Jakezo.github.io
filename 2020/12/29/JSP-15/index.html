
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JSP-15 네이버 캡차 (capcha) - Re-Coder</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Jakezo Obsidian,"> 
    <meta name="description" content="캡차(Capcha) 란 무엇일까로그인 시 자동 입력 방지를 위해 사람의 눈으로 식별가능한 문자가 포함된 이미지를 전송하고 입력값을 검증하는 REST API 입니다.
캡차 만들기 ,"> 
    <meta name="author" content="Jakezo"> 
    <link rel="alternative" href="atom.xml" title="Re-Coder" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">

    
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">

    
<link rel="stylesheet" href="/css/obsidian.css">

    
<link rel="stylesheet" href="/css/ball-atom.min.css">

    
<meta name="generator" content="Hexo 5.3.0"></head>


<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Re-Coder</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="http://jakezo.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">JSP-15 네이버 캡차 (capcha)</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg) ">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/JAVA-WEB"><b>「
                    </b>JAVA-WEB<b> 」</b></a>
                
                December 29, 2020
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2020/12/29/JSP-15/" title="JSP-15 네이버 캡차 (capcha)" class="">JSP-15 네이버 캡차 (capcha)</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    24k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    22 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list" itemprop="keywords"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/API/" rel="tag">API</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/Captcha/" rel="tag">Captcha</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/JSP/" rel="tag">JSP</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="캡차-Capcha-란-무엇일까"><a href="#캡차-Capcha-란-무엇일까" class="headerlink" title="캡차(Capcha) 란 무엇일까"></a>캡차(Capcha) 란 무엇일까</h2><p>로그인 시 자동 입력 방지를 위해 사람의 눈으로 식별가능한 문자가 포함된 이미지를 전송하고 입력값을 검증하는 REST API 입니다.</p>
<h2 id="캡차-만들기-시작"><a href="#캡차-만들기-시작" class="headerlink" title="캡차 만들기 시작"></a>캡차 만들기 시작</h2><h3 id="만들고-싶은-캡챠-화면"><a href="#만들고-싶은-캡챠-화면" class="headerlink" title="만들고 싶은 캡챠 화면"></a>만들고 싶은 캡챠 화면</h3><img src="https://i.esdrop.com/d/kUJdbiA2V8.png"/>

<blockquote>
<p>위와 같은 캡챠 화면을 목표로 만들어 봅시다!</p>
</blockquote>
<h3 id="필요한-라이브러리"><a href="#필요한-라이브러리" class="headerlink" title="필요한 라이브러리"></a>필요한 라이브러리</h3><ul>
<li>json-simple-1.1.1</li>
</ul>
<hr>
<h3 id="index-jsp"><a href="#index-jsp" class="headerlink" title="index.jsp"></a>index.jsp</h3><blockquote>
<p>인덱스 페이지를 만들어 처음 화면을 구성한다.</p>
</blockquote>
<pre><code class="html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Insert title here&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;a href=&quot;/18_CAPCHA/getImageCaptcha.do&quot;&gt;로그인하러 가기&lt;/a&gt;


&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3 id="common"><a href="#common" class="headerlink" title="common"></a>common</h3><blockquote>
<p><strong>PathNRedirect.java</strong></p>
</blockquote>
<hr>
<p><code>pathNRedirect</code> class 를 만들어 경로와 redirect 여부를 반환해준다.</p>
<pre><code class="java">package common;

public class PathNRedirect &#123;

    private String path; //경로
    private boolean isRedirect;  // 리다이렉트 여부.

    public String getPath() &#123;
        return path;
    &#125;
    public void setPath(String path) &#123;
        this.path = path;
    &#125;
    public boolean isRedirect() &#123;
        return isRedirect;
    &#125;
    public void setRedirect(boolean isRedirect) &#123; // Redirect 여부를 묻는 메소드 true: forward | false: redirect
        this.isRedirect = isRedirect; 
    &#125;

&#125;</code></pre>
<hr>
<h3 id="Controller-java"><a href="#Controller-java" class="headerlink" title="Controller.java"></a>Controller.java</h3><blockquote>
<p>컨트롤러를 이용해 요청을 처리한다.</p>
</blockquote>
<pre><code class="java">package controller;

import java.io.IOException;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import command.Command;
import command.GetImageCaptchaCommand;
import command.InputKeyCheckCommand;
import common.PathNRedirect;

@WebServlet(&quot;*.do&quot;) // .do suffix가 .do인 모든 요청을 처리하는 Controller
public class Controller extends HttpServlet &#123;
    private static final long serialVersionUID = 1L;

    public Controller() &#123;
        super();
        // TODO Auto-generated constructor stub
    &#125;

protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;
    request.setCharacterEncoding(&quot;utf-8&quot;);
    response.setContentType(&quot;text/html; charset=UTF-8&quot;);

    String requestUri = request.getRequestURI(); // requestUri 요청 주소 전체를 의미        // /18_CAPCHA/*.do
    String contextPath = request.getContextPath(); // ContextPath: 프로젝트 이름 18_CAPCHA// /18_CAPCHA
    String cmd = requestUri.substring(contextPath.length()); // /*.do

    PathNRedirect pathNRedirect = null;
    Command command = null;
</code></pre>
<h3 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h3><p><code>Command</code> 인터페이스 생성 (MVC의 Model 공통 처리)</p>
<blockquote>
<p>Model</p>
</blockquote>
<ol>
<li>Controller에게 결과와 응답할 VIEW를 반환한다.<ol>
<li>반환값은 응답VIEW이다.</li>
<li>결과값은 request에 저장한다.</li>
</ol>
</li>
<li>매개변수로 HttpServletRequest 클래스 타입의 request가 필요하다.</li>
<li>매개변수로 HttpServletResponse 클래스 타입의 response도 필요할 수 있다.</li>
</ol>
<blockquote>
<p>Command</p>
</blockquote>
<pre><code class="java">package command;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import common.PathNRedirect;

public interface Command &#123;

  public PathNRedirect execute(HttpServletRequest request, HttpServletResponse response);

&#125;</code></pre>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><blockquote>
<p>Controller의 역할</p>
</blockquote>
<ol>
<li><p>요청을 확인하고, 요청을 처리할 Model(Command)을 호출한다.</p>
</li>
<li><p>Model(Command)이 반환한 결과와 응답VIEW를 이용해서 페이지이동(응답)을 한다.</p>
<pre><code> Today today = new Today();
 String path = today.execute(request, response);

 path로 이동
 Today Command가 request에 result를 저장해 주었으므로
 이를 전달하기 위해서 forward한다.</code></pre>
</li>
</ol>
<hr>
<p><code>Controller</code>의 doGet메소드에 추가 작성</p>
<pre><code class="java">protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;
    request.setCharacterEncoding(&quot;utf-8&quot;);
    response.setContentType(&quot;text/html; charset=UTF-8&quot;);

    String requestUri = request.getRequestURI(); // requestUri 요청 주소 전체를 의미        // /18_CAPCHA/*.do
    String contextPath = request.getContextPath(); // ContextPath: 프로젝트 이름 18_CAPCHA// /18_CAPCHA
    String cmd = requestUri.substring(contextPath.length()); // /*.do

    PathNRedirect pathNRedirect = null;
    Command command = null;

    switch(cmd)&#123;
    case &quot;/getImageCaptcha.do&quot;:
        command = new GetImageCaptchaCommand();
        pathNRedirect = command.execute(request, response);
        break;
    &#125;</code></pre>
<p><code>indexPage.java</code> 의 로그인하러 가기<br>의 /getImageCaptcha.do 요청을 Controller에서 처리해 준다.</p>
<blockquote>
<p>로그인을 하러 가면 캡차 이미지가 생성됨</p>
</blockquote>
<h3 id="GetImageCaptchaCommand-생성"><a href="#GetImageCaptchaCommand-생성" class="headerlink" title="GetImageCaptchaCommand 생성"></a>GetImageCaptchaCommand 생성</h3><blockquote>
<p> 캡차 이미지 생성을 위해 만든다.</p>
</blockquote>
<hr>
<p><strong>캡차 키 발급 요청</strong> 과  <strong>이미지를 다운받는다.</strong></p>
<pre><code class="java">package command;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import common.PathNRedirect;

public class GetImageCaptchaCommand implements Command &#123;

    @Override
    public PathNRedirect execute(HttpServletRequest request, HttpServletResponse response) &#123;

        // 네이버 캡차 API

        // 1) 캡차 키 발급 요청하기
        // 2) 캡차 이미지 요청하기
        String clientId = &quot;u7aGTrFmp005OR4CJWy4&quot;; //애플리케이션 클라이언트 아이디값&quot;;
        String clientSecret = &quot;V00UJonEUP&quot;; //애플리케이션 클라이언트 시크릿값&quot;;

        // 1) 캡차 키 발급 요청하기
        String code = &quot;0&quot;; // 키 발급시 0,  캡차 이미지 비교시 1로 세팅
        String apiURL = &quot;https://openapi.naver.com/v1/captcha/nkey?code=&quot; + code;

        Map&lt;String, String&gt; requestHeaders = new HashMap&lt;&gt;();
        requestHeaders.put(&quot;X-Naver-Client-Id&quot;, clientId);
        requestHeaders.put(&quot;X-Naver-Client-Secret&quot;, clientSecret);
        String responseBody = get(apiURL, requestHeaders);
        // System.out.println(responseBody);  // &#123;&quot;key&quot;:&quot;bgbl5MwSZRnQOllo&quot;&#125;
        // responseBody는 &#123;&quot;key&quot;:&quot;bgbl5MwSZRnQOllo&quot;&#125;와 같은 형식의 JSON 데이터

        // json-simple-1.1.1.jar를 이용해서 responseBody에서 &quot;bgbl5MwSZRnQOllo&quot;를 뺀다.
        JSONParser parser = new JSONParser();
        JSONObject obj = null;
        try &#123;
            obj = (JSONObject)parser.parse(responseBody);
        &#125; catch (ParseException e) &#123;
            e.printStackTrace();
        &#125;


        // 입력값 비교(InputKeyCheckCommand)에서 캡차 키를 필요로 하므로,
        // session에 올려 둔다.
        // session은 request에서 알아낸다.
        HttpSession session = request.getSession();
        session.setAttribute(&quot;key&quot;, (String)obj.get(&quot;key&quot;)); // #key session에 보관



        // 2) 캡차 이미지 요청하기
        String key = (String)obj.get(&quot;key&quot;); // https://openapi.naver.com/v1/captcha/nkey 호출로 받은 키값
        // 이미지 수신 실패용(아무 키나 넘김) String key = &quot;aldfakjlkajgj;fljg;sl&quot;;
        String apiURL2 = &quot;https://openapi.naver.com/v1/captcha/ncaptcha.bin?key=&quot; + key;

        // requestHeaders는 1) 캡차 키 발급 요청에서 이미 생성했으므로 또 생성할 필요가 없다.
        /*
        Map&lt;String, String&gt; requestHeaders = new HashMap&lt;&gt;();
        requestHeaders.put(&quot;X-Naver-Client-Id&quot;, clientId);
        requestHeaders.put(&quot;X-Naver-Client-Secret&quot;, clientSecret);
        */

        // responseBody2
        // 1) 성공: 이미지 캡차가 생성되었습니다.
        // 2) 실패: &#123;&quot;result&quot;:false,&quot;errorMessage&quot;:&quot;Invalid key.&quot;,&quot;errorCode&quot;:&quot;CT001&quot;&#125;
        // String responseBody2 = get2(apiURL2, requestHeaders);

        // 성공했을 때는 캡차 이미지 파일이 생성되므로 생성된 파일명을 알아야 한다.
        // responseBody2 -&gt; filename
        String filename = get2(request, apiURL2, requestHeaders);

        // System.out.println(filename);

        PathNRedirect pathNRedirect = new PathNRedirect();
        pathNRedirect.setPath(&quot;login/loginPage.jsp&quot;);
        pathNRedirect.setRedirect(false);  // request에 directory, filename 저장되어 있으므로 forward

        return pathNRedirect;

    &#125;

    // 1) 캡차 키 발급 요청용 get() 메소드
    private static String get(String apiUrl, Map&lt;String, String&gt; requestHeaders)&#123;
        HttpURLConnection con = connect(apiUrl);
        try &#123;
            con.setRequestMethod(&quot;GET&quot;);
            for(Map.Entry&lt;String, String&gt; header :requestHeaders.entrySet()) &#123;
                con.setRequestProperty(header.getKey(), header.getValue());
            &#125;

            int responseCode = con.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) &#123; // 정상 호출
                return readBody(con.getInputStream());
            &#125; else &#123; // 에러 발생
                return readBody(con.getErrorStream());
            &#125;
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 요청과 응답 실패&quot;, e);
        &#125; finally &#123;
            con.disconnect();
        &#125;
    &#125;


    // 1) 캡차 키 발급 요청용 connect() 메소드
    // 2) 캡차 이미지 요청용 connect() 메소드
    private static HttpURLConnection connect(String apiUrl)&#123;
        try &#123;
            URL url = new URL(apiUrl);
            return (HttpURLConnection)url.openConnection();
        &#125; catch (MalformedURLException e) &#123;
            throw new RuntimeException(&quot;API URL이 잘못되었습니다. : &quot; + apiUrl, e);
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;연결이 실패했습니다. : &quot; + apiUrl, e);
        &#125;
    &#125;

    // 1) 캡차 키 발급 요청용 readBody() 메소드
    private static String readBody(InputStream body)&#123;
        InputStreamReader streamReader = new InputStreamReader(body);

        try (BufferedReader lineReader = new BufferedReader(streamReader)) &#123;
            StringBuilder responseBody = new StringBuilder();

            String line;
            while ((line = lineReader.readLine()) != null) &#123;
                responseBody.append(line);
            &#125;

            return responseBody.toString();
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 응답을 읽는데 실패했습니다.&quot;, e);
        &#125;
    &#125;

    // 2) 캡차 이미지 요청용 get2() 메소드
    private static String get2(HttpServletRequest request, String apiUrl, Map&lt;String, String&gt; requestHeaders)&#123;
        HttpURLConnection con = connect(apiUrl);
        try &#123;
            con.setRequestMethod(&quot;GET&quot;);
            for(Map.Entry&lt;String, String&gt; header :requestHeaders.entrySet()) &#123;
                con.setRequestProperty(header.getKey(), header.getValue());
            &#125;

            int responseCode = con.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) &#123; // 정상 호출
                // getImage()에 request를 전달하려면 get2() 메소드가 HttpServletRequest request를 받아와야 한다.
                // 기존: get2(String apiUrl, Map&lt;String, String&gt; requestHeaders) &#123;
                // 수정: get2(HttpServletRequest request, String apiUrl, Map&lt;String, String&gt; requestHeaders) &#123;
                return getImage(request, con.getInputStream());
            &#125; else &#123; // 에러 발생
                return error(con.getErrorStream());
            &#125;
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 요청과 응답 실패&quot;, e);
        &#125; finally &#123;
            con.disconnect();
        &#125;
    &#125;

    // 2) 캡차 이미지 요청용 getImage() 메소드
    private static String getImage(HttpServletRequest request, InputStream is)&#123;
        int read;
        byte[] bytes = new byte[1024];
        // 랜덤한 이름으로 파일 생성(X)
        // 현재 시간: timestamp으로 파일 생성(O)
        String filename = Long.valueOf(new Date().getTime()).toString();

        // 캡차 이미지가 저장될 storage 디렉토리의 경로를 알아낸다.
        String directory = &quot;storage&quot;;

        // HttpServletRequest request가 있어야 realPath를 구할 수 있다.
        // 따라서 execute() 메소드에게서 HttpServletRequest request를 받아 온다.
        // 기존: getImage(InputStream is) &#123; ... &#125;
        // 수정: getImage(HttpServletRequest request, InputStream is)       
        String realPath = request.getServletContext().getRealPath(directory);

        // storage 디렉토리가 안 생기면 강제로 만들어 주는 코드
        File dir = new File(realPath);  // File dir에는 storage 디렉토리 정보가 저장된다.
        if ( !dir.exists() ) &#123;  // dir(storage 디렉토리)이 없으면
            dir.mkdirs();  // 해당 디렉토리(storage 디렉토리)를 생성하라.
        &#125;

        // storage 디렉토리 경로를 포함하도록 File f를 수정한다.
        // 기존: File f = new File(filename + &quot;.jpg&quot;);
        // 수정: File f = new File(realPath, filename + &quot;.jpg&quot;);
        File f = new File(realPath, filename + &quot;.jpg&quot;);

        try(OutputStream outputStream = new FileOutputStream(f))&#123;
            f.createNewFile();
            while ((read = is.read(bytes)) != -1) &#123;
                outputStream.write(bytes, 0, read);
            &#125;


            // directory(상대경로)와 filename을 JSP(로그인화면)에서 확인할 수 있도록
            // request에 저장해 둔다.
            // GetImageCaptchaCommand의 execute() 메소드는 PathNRedirect를 반환하는데,
            // 이 때 반환방법은 forward이다. (request의 데이터 유지를 위해서)
            request.setAttribute(&quot;filename&quot;, filename + &quot;.jpg&quot;);
            request.setAttribute(&quot;directory&quot;, directory);


            // return &quot;이미지 캡차가 생성되었습니다.&quot;;
            return filename;

        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;이미지 캡차 파일 생성에 실패 했습니다.&quot;,e);
        &#125;
    &#125;

    // 2) 캡차 이미지 요청용 error() 메소드
    private static String error(InputStream body) &#123;
        InputStreamReader streamReader = new InputStreamReader(body);

        try (BufferedReader lineReader = new BufferedReader(streamReader)) &#123;
            StringBuilder responseBody = new StringBuilder();

            String line;
            while ((line = lineReader.readLine()) != null) &#123;
                responseBody.append(line);
            &#125;

            return responseBody.toString();
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 응답을 읽는데 실패했습니다.&quot;, e);
        &#125;
    &#125;

&#125;</code></pre>
<hr>
<p><code>GetImageCaptchaCommand</code>메소드 순서 요약</p>
<ol>
<li>네이버 캡차 API에서 clientId 와 password를 발급 받는다.</li>
<li>캡차 키 요청(get() 메소드 활용)을 받고 Json parse를위한 JSONSimple 라이브러리 사용</li>
<li>응답받은 키로 이미지를 요청(get2() 메소드 활용 과 동시에 get2()내부에서 getImage() 메소드도 실행됨.)</li>
<li>getImage()메소드로 이미지 생성</li>
<li>파일명과 파일위치를 반환받아 request 영역에 저장 (String filename, directory)</li>
</ol>
<hr>
<h3 id="indexPage-gt-loginPage"><a href="#indexPage-gt-loginPage" class="headerlink" title="indexPage -&gt;  loginPage"></a>indexPage -&gt;  loginPage</h3><hr>
<p><code>indexPage.jsp</code> 에서 loginPage로 이동해서 생성된 캡차이미지 활용</p>
<pre><code class="html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Insert title here&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;h3&gt;로그인&lt;/h3&gt;

    &lt;form action=&quot;/18_CAPTCHA/login.do&quot; method=&quot;post&quot;&gt;

        &lt;input type=&quot;text&quot; name=&quot;id&quot; placeholder=&quot;아이디&quot; /&gt;&lt;br/&gt;
        &lt;input type=&quot;password&quot; name=&quot;pw&quot; placeholder=&quot;비밀번호&quot; /&gt;&lt;br/&gt;&lt;br/&gt;
        아래 이미지를 보이는 대로 입력하세요.&lt;br/&gt;
        &lt;img alt=&quot;캡차이미지&quot; src=&quot;$&#123;directory&#125;/$&#123;filename&#125;&quot; style=&quot;width: 200px;&quot;&gt;
        &lt;input type=&quot;button&quot; value=&quot;새로고침&quot; onclick=&quot;location.href=&#39;/18_CAPTCHA/getImageCaptcha.do&#39;&quot; /&gt;&lt;br/&gt;
        &lt;input type=&quot;text&quot; name=&quot;input_key&quot; placeholder=&quot;자동입력 방지문자&quot; /&gt;&lt;br/&gt;&lt;br/&gt;
        &lt;button&gt;로그인&lt;/button&gt;

    &lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3 id="login-do-Controller-생성"><a href="#login-do-Controller-생성" class="headerlink" title="login.do Controller 생성"></a>login.do Controller 생성</h3><hr>
<blockquote>
<p>위 코드 (<code>index의-로그인하러-가기</code>)에 추가</p>
</blockquote>
<pre><code class="java">switch(cmd)&#123;
    case &quot;/getImageCaptcha.do&quot;:
        command = new GetImageCaptchaCommand();
        pathNRedirect = command.execute(request, response);
        break;
    case &quot;/loginPage.do&quot;;
        command = new InputKeyCheckCommand();
        pathNRedirect = command.execute(request, response);
        break;
    &#125;</code></pre>
<h3 id="InputKeyCheckCommand"><a href="#InputKeyCheckCommand" class="headerlink" title="InputKeyCheckCommand"></a>InputKeyCheckCommand</h3><blockquote>
<p> <code>login.do</code> 의 모델 captcha 이미지와 입력값을 비교한다.</p>
</blockquote>
<hr>
<pre><code class="java">package command;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import common.PathNRedirect;

public class InputKeyCheckCommand implements Command &#123;

    @Override
    public PathNRedirect execute(HttpServletRequest request, HttpServletResponse response) &#123;

        String clientId = &quot;u7aGTrFmp005OR4CJWy4&quot;;  //애플리케이션 클라이언트 아이디값&quot;;
        String clientSecret = &quot;V00UJonEUP&quot;;  //애플리케이션 클라이언트 시크릿값&quot;;

        String code = &quot;1&quot;; // 키 발급시 0,  캡차 이미지 비교시 1로 세팅

        // session에서 key 가져오면 발급 받은 캡차 발급 키를 알 수 있다.
        HttpSession session = request.getSession();
        String key = (String)session.getAttribute(&quot;key&quot;);  // 캡차 키 발급시 받은 키값
        String value = request.getParameter(&quot;input_key&quot;);  // 사용자가 입력한 캡차 이미지 글자값
        String apiURL = &quot;https://openapi.naver.com/v1/captcha/nkey?code=&quot; + code + &quot;&amp;key=&quot; + key + &quot;&amp;value=&quot; + value;

        Map&lt;String, String&gt; requestHeaders = new HashMap&lt;&gt;();
        requestHeaders.put(&quot;X-Naver-Client-Id&quot;, clientId);
        requestHeaders.put(&quot;X-Naver-Client-Secret&quot;, clientSecret);
        String responseBody = get(apiURL, requestHeaders);

        System.out.println(responseBody);
        // responseBody
        // 성공: &#123;&quot;result&quot;:true,&quot;responseTime&quot;:21.39&#125;
        // 실패: &#123;&quot;result&quot;:false,&quot;responseTime&quot;:5.76&#125;

        // result를 responseBody에서 꺼낸다.
        JSONParser parser = new JSONParser();
        JSONObject obj = null;
        try &#123;
            obj = (JSONObject)parser.parse(responseBody);
        &#125; catch (ParseException e) &#123;
            e.printStackTrace();
        &#125;
        boolean result = (boolean)obj.get(&quot;result&quot;);


        // loginResult.jsp로 result값(true, false)을 보내기 위해서
        // request에 result를 저장해 둔다. 그리고 forward 한다.
        request.setAttribute(&quot;result&quot;, result);

        PathNRedirect pathNRedirect = new PathNRedirect();
        pathNRedirect.setPath(&quot;login/loginResult.jsp&quot;);
        pathNRedirect.setRedirect(false);  // forward

        return pathNRedirect;

    &#125;

    private static String get(String apiUrl, Map&lt;String, String&gt; requestHeaders)&#123;
        HttpURLConnection con = connect(apiUrl);
        try &#123;
            con.setRequestMethod(&quot;GET&quot;);
            for(Map.Entry&lt;String, String&gt; header :requestHeaders.entrySet()) &#123;
                con.setRequestProperty(header.getKey(), header.getValue());
            &#125;

            int responseCode = con.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) &#123; // 정상 호출
                return readBody(con.getInputStream());
            &#125; else &#123; // 에러 발생
                return readBody(con.getErrorStream());
            &#125;
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 요청과 응답 실패&quot;, e);
        &#125; finally &#123;
            con.disconnect();
        &#125;
    &#125;

    private static HttpURLConnection connect(String apiUrl)&#123;
        try &#123;
            URL url = new URL(apiUrl);
            return (HttpURLConnection)url.openConnection();
        &#125; catch (MalformedURLException e) &#123;
            throw new RuntimeException(&quot;API URL이 잘못되었습니다. : &quot; + apiUrl, e);
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;연결이 실패했습니다. : &quot; + apiUrl, e);
        &#125;
    &#125;

    private static String readBody(InputStream body)&#123;
        InputStreamReader streamReader = new InputStreamReader(body);

        try (BufferedReader lineReader = new BufferedReader(streamReader)) &#123;
            StringBuilder responseBody = new StringBuilder();

            String line;
            while ((line = lineReader.readLine()) != null) &#123;
                responseBody.append(line);
            &#125;

            return responseBody.toString();
        &#125; catch (IOException e) &#123;
            throw new RuntimeException(&quot;API 응답을 읽는데 실패했습니다.&quot;, e);
        &#125;
    &#125;

&#125;</code></pre>
<p>request에 비교한 입력값에대한 결과를 <code>boolean</code> 타입으로 저장시켜 준다.<br>그리고 Path와 Redirect 유무를 가진 <strong>PathNRedirect</strong> 를 반환해준다.</p>
<h3 id="결과-출력-Page"><a href="#결과-출력-Page" class="headerlink" title="결과 출력 Page"></a>결과 출력 Page</h3><blockquote>
<p>loginPage.jsp</p>
</blockquote>
<pre><code class="html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;script&gt;
    if ( $&#123;result&#125; ) &#123;
        alert(&#39;성공입니다.&#39;);
        location.href = &#39;/18_CAPTCHA/index.do&#39;;
    &#125; else &#123;
        alert(&#39;실패입니다.&#39;);
        // history.back();  새로운 이미지를 받아서 다시 시도할 수 있도록 새로운 캡차 이미지를 받아야 한다.
        location.href = &#39;/18_CAPTCHA/getImageCaptcha.do&#39;;
    &#125;
&lt;/script&gt;</code></pre>
<h2 id="결과-페이지"><a href="#결과-페이지" class="headerlink" title="결과 페이지"></a>결과 페이지</h2><img src="https://i.esdrop.com/d/yKWHJ8GAN2.png"/>

<p>그 후에 맨 위와 같은 화면이 나오고</p>
<img src="https://i.esdrop.com/d/Es5ZlPkRxN.png"/>

<p>캡챠를 제대로 입력하면 뜨는 화면입니다.</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='b71d412ba1e7a1a6a699'
        data-cs='b5058587509d4ec60e52677d4c79d46bae266b57'
        data-r='gitalkHexoComment'
        data-o='Jakezo'
        data-a='Jakezo'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="/img/logo_icon.png" height=300 width=300></img>
                    <p>Jakezo</p>
                    <span>Think like an artist, develop like an artisan</span>
                    <dl>
                        <dd><a href="https://github.com/Jakezo" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">39 <p>Articles</p></a></li>
                    <li><a href="/categories">8 <p>Categories</p></a></li>
                    <li><a href="/tags">33 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%BA%A1%EC%B0%A8-Capcha-%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C"><span class="toc-number">1.</span> <span class="toc-text">캡차(Capcha) 란 무엇일까</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%BA%A1%EC%B0%A8-%EB%A7%8C%EB%93%A4%EA%B8%B0-%EC%8B%9C%EC%9E%91"><span class="toc-number">2.</span> <span class="toc-text">캡차 만들기 시작</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%A7%8C%EB%93%A4%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EC%BA%A1%EC%B1%A0-%ED%99%94%EB%A9%B4"><span class="toc-number">2.1.</span> <span class="toc-text">만들고 싶은 캡챠 화면</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%95%84%EC%9A%94%ED%95%9C-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC"><span class="toc-number">2.2.</span> <span class="toc-text">필요한 라이브러리</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#index-jsp"><span class="toc-number">2.3.</span> <span class="toc-text">index.jsp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#common"><span class="toc-number">2.4.</span> <span class="toc-text">common</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-java"><span class="toc-number">2.5.</span> <span class="toc-text">Controller.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Command"><span class="toc-number">2.6.</span> <span class="toc-text">Command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller"><span class="toc-number">2.7.</span> <span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetImageCaptchaCommand-%EC%83%9D%EC%84%B1"><span class="toc-number">2.8.</span> <span class="toc-text">GetImageCaptchaCommand 생성</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#indexPage-gt-loginPage"><span class="toc-number">2.9.</span> <span class="toc-text">indexPage -&gt;  loginPage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#login-do-Controller-%EC%83%9D%EC%84%B1"><span class="toc-number">2.10.</span> <span class="toc-text">login.do Controller 생성</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InputKeyCheckCommand"><span class="toc-number">2.11.</span> <span class="toc-text">InputKeyCheckCommand</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EA%B2%B0%EA%B3%BC-%EC%B6%9C%EB%A0%A5-Page"><span class="toc-number">2.12.</span> <span class="toc-text">결과 출력 Page</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EA%B2%B0%EA%B3%BC-%ED%8E%98%EC%9D%B4%EC%A7%80"><span class="toc-number">3.</span> <span class="toc-text">결과 페이지</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.85}});</script></body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2021
        <span class="gradient-text">
            Jakezo
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.4" target="_blank" rel="noopener">v1.4.4</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>


 
<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
 
<script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
  
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>
 
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
 
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
 
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>


<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>
 
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>
   
<script src="/js/busuanzi.min.js"></script>

<script>
  $(document).ready(function () {
    if ($('span[id^="busuanzi_"]').length) {
      initialBusuanzi();
    }
  });
</script>
 
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">


<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'UA-149874671-1');
</script>
 

<script>
  function initialTyped() {
    var typedTextEl = $('.typed-text');
    if (typedTextEl && typedTextEl.length > 0) {
      var typed = new Typed('.typed-text', {
        strings: ['Think like an artist, develop like an artisan', 'It doesn&#39;t matter how slowly you go as long as you don&#39;t stop'],
        typeSpeed: 90,
        loop: true,
        loopCount: Infinity,
        backSpeed: 20,
      });
    }
  }

  if ($('.article-header') && $('.article-header').length) {
    $(document).ready(function () {
      initialTyped();
    });
  }
</script>




 <!-- 例：百度统计 --> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?your_code"; var s = document.getElementsByTagName("script")[0];  s.parentNode.insertBefore(hm, s); })(); </script> 

</html>
